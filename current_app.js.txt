// --- 0. INITIALIZATION & GLOBAL EXPOSURE ---
window.handleCredentialResponse = handleCredentialResponse;
window.guestLogin = guestLogin;
window.logout = logout;
window.onClassChange = onClassChange;
window.showDashboard = showDashboard;
window.showLoginAgain = showLoginAgain;

let syllabus = {};
let notesData = {}; 
let currentUser = { name: "Guest", pic: "images/guest-profile.png", type: "Guest" };

function escapeJS(str) {
    return str.replace(/'/g, "\\'");
}

// --- 1. AUTHENTICATION ---
function handleCredentialResponse(response) {
    try {
        const token = response.credential;
        const payload = JSON.parse(window.atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
        currentUser = { name: payload.name, pic: payload.picture, type: "Google" };
        transitionToApp();
    } catch (e) {
        console.error("Login failed:", e);
    }
}

function guestLogin() {
    currentUser = { name: "Guest", pic: "images/guest-profile.png", type: "Guest" }; 
    transitionToApp();
}

function logout() {
    document.getElementById("app").classList.add('hidden');
    document.getElementById("loginScreen").classList.remove('hidden');
}

function transitionToApp() {
    document.getElementById("splash").classList.add('hidden');
    document.getElementById("loginScreen").classList.add('hidden');
    document.getElementById("app").classList.remove('hidden');
    document.getElementById("user-name").innerText = currentUser.name;
    document.getElementById("user-pic").src = currentUser.pic;
    document.getElementById("user-area").style.display = 'flex';
    populateClassSelect();
}

// --- 2. DATA LOADING ---
async function loadContentData() {
    try {
        const response = await fetch('content.json');
        if (!response.ok) throw new Error("Fetch failed");
        const data = await response.json();
        syllabus = data.syllabus || {};
        notesData = data.notes || {};
    } catch (error) {
        console.error("Error loading content.json:", error);
    } finally {
        document.getElementById("splash").classList.add('hidden');
        document.getElementById("loginScreen").classList.remove('hidden');
    }
}

function populateClassSelect() {
    const classSelect = document.getElementById("classSelect");
    if (!classSelect) return;
    classSelect.innerHTML = '<option value="">-- Select Class --</option>';
    const classes = Object.keys(syllabus).sort((a, b) => a - b);
    if (classes.length > 0) {
        classSelect.innerHTML += classes.map(c => `<option value="${c}">Class ${c}</option>`).join('');
        classSelect.value = classes[0];
        onClassChange();
    }
}

function onClassChange() {
    const selectedClass = document.getElementById("classSelect").value;
    const subArea = document.getElementById("subjectButtons");
    subArea.innerHTML = '';
    if (!selectedClass || !syllabus[selectedClass]) return;
    
    const subjects = Object.keys(syllabus[selectedClass]);
    subArea.innerHTML = subjects.map(sub => 
        `<button class="subject-btn" onclick="showChapters('${selectedClass}', '${sub}')">
            ${sub.charAt(0).toUpperCase() + sub.slice(1)}
         </button>`).join('');
    if (subjects.length > 0) showChapters(selectedClass, subjects[0]);
}

function showChapters(selectedClass, selectedSubject) {
    const chaptersArea = document.getElementById("chaptersArea");
    const chapters = syllabus[selectedClass][selectedSubject] || [];
    chaptersArea.innerHTML = '<h4>Chapters</h4>';
    chaptersArea.innerHTML += chapters.map(chapter => 
        `<div class="chapter-card" onclick="showChapterContent('${escapeJS(chapter)}')">
            <span>${chapter.replace(/-/g, ' ')}</span>
            <span class="chapter-progress">0%</span>
        </div>`).join('');
}

// --- 3. CONTENT RENDERING ---

function showChapterContent(chapterName) {
    const contentArea = document.getElementById("contentArea");
    contentArea.classList.remove('centered');
    contentArea.innerHTML = `
        <h2>${chapterName.replace(/-/g, ' ')}</h2>
        <div class="content-controls">
            <button class="quiz-btn" onclick="showNotes('${escapeJS(chapterName)}')">View Notes</button>
            <button class="quiz-btn" onclick="startQuiz('${escapeJS(chapterName)}')">Take Quiz</button>
            <button class="quiz-btn" onclick="showQuestionBank('${escapeJS(chapterName)}')">Question Bank</button>
        </div>
        <div id="notesContainer" class="notes-content content-section"></div>
        <div id="quizContainer" class="quiz-area content-section"></div>
        <div id="questionBankContainer" class="qb-area content-section"></div>
    `;
    showNotes(chapterName);
}

// --- 4. QUESTION BANK (Working Logic) ---
async function showQuestionBank(chapterName) {
    const qbArea = document.getElementById("questionBankContainer");
    document.getElementById("notesContainer").innerHTML = "";
    document.getElementById("quizContainer").innerHTML = "";
    qbArea.style.display = 'block';
    qbArea.innerHTML = `<p>Loading Question Bank...</p>`;

    try {
        const response = await fetch(`data/questionBank/${chapterName.trim()}.json`);
        if (!response.ok) throw new Error("File not found");
        const data = await response.json();
        renderQuestionBank(data, qbArea);
    } catch (err) {
        qbArea.innerHTML = `<p>No Question Bank found at <code>data/questionBank/${chapterName}.json</code></p>`;
    }
}

function renderQuestionBank(data, container) {
    container.innerHTML = "<h3>Question Bank</h3>";
    for (const category in data) {
        container.innerHTML += `<h4 style="margin-top:20px; color:var(--primary);">${category}</h4>`;
        data[category].forEach((item, index) => {
            container.innerHTML += `
                <div class="qp-question">
                    <p><strong>Q:</strong> ${item.q}</p>
                    <button class="show-answer-btn" onclick="this.nextElementSibling.classList.toggle('hidden')">Show Answer</button>
                    <div class="qp-answer hidden">
                        <div class="answer-label">Answer:</div>
                        ${item.a}
                    </div>
                </div>`;
        });
    }
}

// --- 5. INTERACTIVE QUIZ (Updated Logic) ---
async function startQuiz(chapterName) {
    const quizDiv = document.getElementById("quizContainer");
    document.getElementById("notesContainer").innerHTML = "";
    document.getElementById("questionBankContainer").innerHTML = "";
    quizDiv.style.display = 'block';
    quizDiv.innerHTML = `<p>Loading Quiz...</p>`;

    try {
        const response = await fetch(`data/quizzes/${chapterName.trim()}.json`);
        if (!response.ok) throw new Error("Quiz file not found");
        const questions = await response.json();
        renderInteractiveQuiz(questions, quizDiv);
    } catch (err) {
        quizDiv.innerHTML = `<p style="color:red;">Error: Could not load quiz for ${chapterName}.</p>`;
    }
}

function renderInteractiveQuiz(questions, container) {
    // Standardized header to match your app's style
    container.innerHTML = `<h2 style="text-align:center; margin-bottom:20px; color:var(--primary);">Interactive Quiz</h2>`;
    
    questions.forEach((item, index) => {
        const qCard = document.createElement('div');
        // Using inline styles to protect your layout from "scrambling"
        qCard.style = "background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);";
        
        let optionsHTML = item.options.map(opt => `
            <label style="display: block; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                <input type="radio" name="q${index}" value="${opt}" style="margin-right: 10px; transform: scale(1.2);">
                <span>${opt}</span>
            </label>
        `).join('');

        qCard.innerHTML = `
            <p style="font-weight: 600; font-size: 1.05rem; margin-bottom: 15px;">Q${index + 1}: ${item.q}</p>
            <div class="options-group">${optionsHTML}</div>
            <div id="feedback-${index}" class="hidden" style="margin-top: 15px; padding: 12px; border-radius: 8px;"></div>
        `;
        container.appendChild(qCard);
    });

    // Create the Submit Button
    const submitBtn = document.createElement('button');
    submitBtn.innerText = "Check My Answers";
    submitBtn.style = "display: block; width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px;";
    
    submitBtn.onclick = () => {
        let score = 0;
        questions.forEach((item, index) => {
            const selected = document.querySelector(`input[name="q${index}"]:checked`);
            const feedback = document.getElementById(`feedback-${index}`);
            feedback.classList.remove('hidden');

            if (selected && selected.value === item.a) {
                score++;
                feedback.style.background = "#d4edda";
                feedback.style.color = "#155724";
                feedback.innerHTML = `<strong>✅ Correct!</strong><br>${item.explanation || ''}`;
            } else {
                feedback.style.background = "#f8d7da";
                feedback.style.color = "#721c24";
                feedback.innerHTML = `<strong>❌ Incorrect.</strong> Correct answer: <b>${item.a}</b><br><em>${item.explanation || ''}</em>`;
            }
        });
        
        // Final score summary
        const scoreSummary = document.createElement('div');
        scoreSummary.style = "text-align: center; font-size: 1.2rem; font-weight: bold; margin-top: 20px; padding: 15px; background: #eef6ff; border-radius: 10px;";
        scoreSummary.innerHTML = `Your Score: ${score} / ${questions.length}`;
        container.prepend(scoreSummary);
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    container.appendChild(submitBtn);
}
// --- 6. NOTES & DASHBOARD ---
async function showNotes(chapterName) {
    const notesDiv = document.getElementById("notesContainer");
    document.getElementById("quizContainer").innerHTML = "";
    document.getElementById("questionBankContainer").innerHTML = "";
    notesDiv.style.display = 'block';

    if (notesData[chapterName]) {
        try {
            const response = await fetch(notesData[chapterName]);
            notesDiv.innerHTML = await response.text();
        } catch (err) {
            notesDiv.innerHTML = `<p>Error loading notes.</p>`;
        }
    }
}

function showDashboard() {
    const contentArea = document.getElementById("contentArea");
    contentArea.innerHTML = '<h2>Dashboard</h2><p>Your progress tracking will appear here.</p>';
}

function showLoginAgain() {
    document.getElementById("app").classList.add('hidden');
    document.getElementById("loginScreen").classList.remove('hidden');
}

document.addEventListener('DOMContentLoaded', loadContentData);